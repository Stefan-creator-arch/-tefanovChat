<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>≈†tefanov Chat üü¢</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/733/733585.png">
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f0f2f5; display: flex; flex-direction: column; height: 100vh; }
        .hlavicka { background-color: #0084ff; color: white; padding: 10px; text-align: center; font-weight: bold; }
        
        /* Zoznam online ƒæud√≠ */
        #online-lista { background: #fff; padding: 8px; font-size: 0.8em; border-bottom: 1px solid #ddd; color: #2ecc71; text-align: center; font-weight: bold; }
        .bodka { height: 10px; width: 10px; background-color: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blikanie 1.5s infinite; }
        @keyframes blikanie { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #chat-okno { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #e5ddd5; }
        .sprava { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 0.9em; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .odoslana { background-color: #dcf8c6; align-self: flex-end; color: black; }
        .prijata { background-color: white; align-self: flex-start; color: black; }
        
        .pisanielista { background-color: white; padding: 10px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        button.send-btn { background-color: #0084ff; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="hlavicka">
        ≈†tefanov Messenger üîî<br>
        <button onclick="vymazatVsetko()" style="background: #ff4444; color: white; border: none; padding: 4px 10px; border-radius: 5px; margin-top: 5px; font-size: 0.6em; cursor: pointer;">üóëÔ∏è Vymaza≈• hist√≥riu</button>
    </div>

    <div id="online-lista"><span class="bodka"></span>Pr√°ve online: <span id="zoznam-mien">prip√°janie...</span></div>
    
    <div style="text-align:center; font-size: 0.7em; color: gray; padding: 5px; background: #f0f2f5;" id="stav-zvuku" onclick="aktivujZvuk()">üîä Klikni sem pre zvuk</div>
    
    <div id="chat-okno"></div>
    
    <div class="pisanielista">
        <input type="text" id="vstup" placeholder="Nap√≠≈° spr√°vu...">
        <button class="send-btn" id="tlacidloPoslat">></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs, deleteDoc, doc, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdhUJoq7szgFbp8WN5bTKx3Ib6OR8Oh5o",
            authDomain: "stefanov-chat.firebaseapp.com",
            projectId: "stefanov-chat",
            storageBucket: "stefanov-chat.firebasestorage.app",
            messagingSenderId: "915409159507",
            appId: "1:915409159507:web:d4fade5388b7822968cda6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const spravyRef = collection(db, "spravy");
        const onlineRef = collection(db, "online_uzivatelia");
        const zvuk = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        let menoUzivatela = prompt("Zadaj svoje meno pre chat:") || "Hos≈•_" + Math.floor(Math.random() * 1000);
        let prveNacitanie = true;

        // --- PRESENCE SYST√âM (Kto je online) ---
        const mojOnlineDoc = doc(db, "online_uzivatelia", menoUzivatela);
        
        // Pridaj ma do zoznamu
        setDoc(mojOnlineDoc, { meno: menoUzivatela, cas: Date.now() });

        // Sleduj zoznam ostatn√Ωch
        onSnapshot(onlineRef, (snapshot) => {
            let mena = [];
            snapshot.forEach(d => mena.push(d.data().meno));
            document.getElementById('zoznam-mien').innerText = mena.join(", ");
        });

        // Odstr√°≈à ma, keƒè zavriem okno
        window.onbeforeunload = () => { deleteDoc(mojOnlineDoc); };

        // --- ZVUKOV√â FUNKCIE ---
        window.aktivujZvuk = function() {
            zvuk.play().then(() => {
                zvuk.pause();
                document.getElementById('stav-zvuku').innerText = "Zvuk: ‚úÖ AKT√çVNY";
                document.getElementById('stav-zvuku').style.color = "green";
            });
        };

        // --- POSIELANIE SPR√ÅV ---
        async function poslatSpravu() {
            const vstup = document.getElementById('vstup');
            if (vstup.value.trim() !== "") {
                await addDoc(spravyRef, { text: vstup.value, cas: Date.now(), autor: menoUzivatela });
                vstup.value = "";
            }
        }

        document.getElementById('tlacidloPoslat').onclick = poslatSpravu;
        document.getElementById('vstup').addEventListener('keypress', (e) => { if (e.key === 'Enter') poslatSpravu(); });

        // --- MAZANIE ---
        window.vymazatVsetko = async function() {
            if (confirm("Vymaza≈• cel√∫ hist√≥riu spr√°v pre v≈°etk√Ωch?")) {
                const snapshot = await getDocs(spravyRef);
                snapshot.forEach(async (d) => { await deleteDoc(doc(db, "spravy", d.id)); });
            }
        };

        // --- ƒå√çTANIE SPR√ÅV A P√çPNUTIE ---
        onSnapshot(query(spravyRef, orderBy("cas", "asc")), (snapshot) => {
            const okno = document.getElementById('chat-okno');
            if (!prveNacitanie) {
                snapshot.docChanges().forEach(z => {
                    if (z.type === "added" && z.doc.data().autor !== menoUzivatela) zvuk.play().catch(()=>{});
                });
            }
            okno.innerHTML = ""; 
            snapshot.forEach((doc) => {
                const data = doc.data();
                const div = document.createElement('div');
                div.classList.add('sprava', data.autor === menoUzivatela ? 'odoslana' : 'prijata');
                div.innerHTML = `<small style="font-size:0.7em; font-weight:bold; opacity:0.6;">${data.autor}</small><br>${data.text}`;
                okno.appendChild(div);
            });
            okno.scrollTop = okno.scrollHeight;
            prveNacitanie = false;
        });
    </script>
</body>
</html>
